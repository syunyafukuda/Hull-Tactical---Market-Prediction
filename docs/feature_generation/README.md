# 特徴量生成ロードマップ

最終更新: 2025-11-01

これまでにすべての特徴量グループ（M/E/I/P/S/V）について欠損補完ポリシー戦略と Kaggle LB 検証を完了した。次のフェーズでは、新規特徴量の生成と拡充を体系的に進める。以下に網羅候補と実装ガードライン、実行優先度を整理する。

---

## 網羅リスト（生成候補）

### A. ローリング・拡張統計（情報漏洩なし）
- 移動平均/中央値/分位点（3, 5, 10, 20, 60, 120 日）
- 拡張平均・分散（expanding）
- EWMA / EWMVar / EWMStd（半減期 = 5, 10, 20, 60）
- 正規化系: ローリング Z 分数、拡張 Z、MAD 基準の Robust-Z
- 乖離系: 値 − 長期平均、比率、シグモイド圧縮

### B. モメンタム / リバーサル変換
- 1, 2, 5, 10, 20 日差分・符号・累積リターン類似変換
- RSI 風: 上昇/下落成分の比
- 短長期のゴールデンクロス指標（短期 > 長期のブール）

### C. ボラティリティ・リスク制御（MSR 直結）
- ローカル実現ボラ: |Δx| の移動平均、平方差の移動和
- ボラレジーム判定: 短期 EWMStd が長期 EWMStd を超過、r = σ_short / σ_long
- ボラ調整値: x / (1 + σ_short) や x * clip(1/r, ...)
- ドローダウン / 回復日数の簡易代理

### D. 相関・合成（群内に限定）
- 群内主成分 (PCA) 第 1–3 成分
- 高相関ペアの差分・比（スパース合成）
- VIF > 10 の列は合成後に除去候補

### E. 交互作用（リーンに限定）
- レジーム × 基礎特徴の交差（例: RegimeLowVol * feature）
- 非線形基底: tanh(x), log1p(|x|) * sign(x) の最小構成

### F. 欠損構造の活用
- 欠損フラグ（列ごと／群ごと／当日総欠損数）
- 直近観測からの経過日数（ffill 距離）
# 特徴量生成ロードマップ（着手順）

最終更新: 2025-11-01

全グループ（M/E/I/P/S/V）の欠損補完ポリシーを確定し、Kaggle LB 検証まで完了した。次フェーズでは本ドキュメントの順序で特徴量生成 PoC を進める。各ステップは時系列リーク防止と CV 内 fit→transform を前提とし、V グループは当面非変換（スケーリングのみ別検証）とする。

---

## 1. ガードライン（共通）

- 指標算出はすべて過去情報のみ。テスト 10 日分には学習期で fit した統計を持ち越す。
- パイプライン順序は「特徴生成 → 欠損補完（既定ポリシー）→ スケーリング」で固定。
- PoC は TimeSeriesSplit+gap による OOF MSR/Sharpe を必須とし、結果を `results/ablation/feature_generation/` に集約する。

---

## 2. 欠損構造特徴（全群、V 除外）

- **2.1 欠損フラグ**: 列単位 `isna_col`、群単位 `miss_rate_group`、当日総欠損数 `miss_cnt_all`。
- **2.2 直近観測距離**: 各列の `last_obs_gap`（ffill 距離、上限 `clip=60`）。
- **2.3 実装案**: `MissingnessFlags(cols_by_group, max_gap=60)`。
- **2.4 テスト**: 全 NaN 列、先頭連続 NaN、島状 NaN の 3 ケースで期待値一致。

---

## 3. ローリング統計（短・中・長）

- **3.1 窓設定**: \(W = \{3,5,10,20,60,120\}\)。
- **3.2 指標**: `mean`, `median`, `std`, `q10`, `q90`, `iqr`, `min`, `max`, `ema`（halflife=`{5,10,20,60}`）。
- **3.3 乖離系**: `x - roll_mean_W` と `x / (ε + roll_std_W)`。
- **3.4 実装案**: `RollingStats(windows=W, percentiles=(10,90), ema_halflife=(5,10,20,60))`。
- **3.5 ガード**: `min_periods=W` とし窓不足時は NaN 維持。
- **3.6 テスト**: 単調系列で閉形式に一致、境界インデックスで NaN を確認。

---

## 4. 拡張 Z・Robust-Z（expanding）

- **4.1 標準化**: 拡張平均・標準偏差で `z_exp=(x-μ_t)/σ_t`。初期除外 `burn_in=20`。
- **4.2 Robust-Z**: `(x-med_t)/(1.4826*MAD_t + ε)`。
- **4.3 実装案**: `ExpandingNormalizer(burn_in=20, robust=True)`。
- **4.4 テスト**: ホールドアウト分割で学習統計のみ用い test を正規化。

---

## 5. ボラティリティ特徴

- **5.1 局所変動**: `abs(Δx)` の `ema` / `mean`（窓はセクション 3 と同一）。二乗差 `(x - roll_mean)^2` の `roll_sum`。
- **5.2 σ 比**: `r = ewmstd_short / (ε + ewmstd_long)` （short ∈ {5,10}, long ∈ {20,60}）。
- **5.3 ボラ調整**: `x_adj = x / (1 + ewmstd_short)`。
- **5.4 実装案**: `VolFeatures(ewm_pairs=[(5,20),(10,60)], adjust=True)`。
- **5.5 テスト**: 定数列で 0、ホワイトノイズで推定 σ が理論値に近いか確認。

---

## 6. レジームタグ

- **6.1 ボラ区分**: `r` の分位 (0.33, 0.66) で低/中/高ボラの 3 値タグ。
- **6.2 トレンド代理**: 短期平滑 > 長期平滑 のブール（ゴールデンクロス指標）。
- **6.3 実装案**: `RegimeTagger(inputs=['r','ma_short','ma_long'], quantiles=(0.33,0.66))`。
- **6.4 テスト**: 人工系列でタグ切り替えが期待通りか検証。

---

## 7. レジーム × 基礎特徴の交差

- **7.1 交差方式**: `x * I(low_vol)`, `x * I(mid_vol)`, `x * I(high_vol)` のダミー乗算。
- **7.2 過学習抑制**: 対象は核となる特徴（各群で上位相関 10 列）に限定。`select_topK_by_variance/corr` で抽出。
- **7.3 実装案**: `RegimeInteractions(selected_cols, regime_cols)`。
- **7.4 テスト**: One-hot 漏れがなく、交差特徴の和が元の `x` に一致しないことを確認。

---

## 8. モメンタム / リバーサル簡易変換

- **8.1 差分**: `diff_k`（k∈{1,2,5,10,20}）、符号 `sign(diff_1)`。
- **8.2 RSI 風**: `rs = ema(gains)/ema(losses+ε)`、`rsi = rs/(1+rs)`。
- **8.3 クロス判定**: 短長期平均の `cross_up` / `cross_down` ブール。
- **8.4 実装案**: `MomentumLite(diffs=[1,2,5,10,20], rsi_halflife=5)`。
- **8.5 テスト**: 単調増加列で RSI→1、往復列で 0.5 付近となるか確認。

---

## 9. カレンダー特徴（決定可能情報のみ）

- **9.1 基本タグ**: `dow`, `dom`, `month`, `qtr`, `yday`。末日・四半期末・年末フラグ。
- **9.2 祝日前後**: 提供カレンダー基準のブリッジフラグ。
- **9.3 実装案**: `CalendarFeatures(holidays=provided_calendar)`。
- **9.4 テスト**: 日付境界の整合とリーク防止を確認。

---

## 10. 非線形基底の少数追加

- **10.1 基底**: `tanh(αx)`（α∈{0.5,1.0}), `log1p(|x|)*sign(x)`。
- **10.2 対象**: 拡張 Z 済みの中核列のみ。
- **10.3 実装案**: `NonlinearBasis(target_cols, kinds=['tanh','log1pabs'])`。
- **10.4 テスト**: 無限大や NaN が発生しないことを確認。

---

## 11. 群内 PCA と高相関合成（任意・後回し可）

- **11.1 高相関ペア**: |ρ|>0.95 の組み合わせで差分・比を 1–2 本のみ生成。
- **11.2 PCA**: 群内 PCA の第 1–3 成分（`whiten=False`、fit は CV 内）。
- **11.3 実装案**: `GroupPCA(groups, n_components=3)` と `PairwiseComposites(corr_thr=0.95)`。
- **11.4 テスト**: 分散保持率 ≥ 60% を確認。

---

## 12. クリーニングと選択

- **12.1 高相関除去**: |ρ|>0.98 で片方 drop（学習折内統計）。
- **12.2 VIF**: VIF>10 を除外候補として多重共線性を縮小。
- **12.3 PSI**: train 後期 vs test の PSI を算出し、PSI>0.3 を要監視。
- **12.4 実装案**: `FeatureSelect(corr=0.98, vif=10.0, psi_bins=10)`。
- **12.5 テスト**: 除去前後で学習安定性が向上するか確認。

---

## 13. スケーリング（CV 内 fit）

- **13.1 群別戦略**: `RobustScaler` を優先、次点 `StandardScaler`。外れ値の多い群は Robust。
- **13.2 適用順**: 生成 → 欠損補完 → スケーリング（既定ポリシーを踏襲）。
- **13.3 実装案**: `GroupScaler(strategy={'M':'robust','E':'robust','I':'standard','P':'robust','S':'standard'})`。
- **13.4 テスト**: train 統計で test を変換し、平均 0 付近・スケール安定を確認。

---

## 14. パイプライン統合と A/B

- **14.1 順序固定**: `sklearn.Pipeline` で `[Missingness → Rolling → ExpandingZ → Vol → Regime → Interactions → Momentum → Calendar → Nonlinear → Select → Scale]`。
- **14.2 評価**: TimeSeriesSplit+gap で OOF MSR を測定し、ベースライン比で平均上昇・分散減少を確認。
- **14.3 ログ**: 追加前後の OOF Sharpe、LB 差分、予測分布（平均/分散/尖度）を記録。
- **14.4 採用条件**: OOF MSR が +1σ 上振れ、かつ LB 非劣敗。劣敗時はロールバック。

---

## 15. 昇格と凍結

- **15.1 設定保存**: 勝ち設定を `configs/fe_*.yaml` に反映しタグ付け。
- **15.2 記録**: `docs/submissions.md` に OOF 指標・LB・差分要約・列数・学習時間を追記。
- **15.3 V グループ**: 引き続き非変換。スケーリングのみ許容するかは別 A/B で判断。

---

## 優先スプリント

- **Sprint 1**: セクション 2–7（欠損構造〜レジーム交差）
- **Sprint 2**: セクション 8–10（モメンタム・カレンダー・非線形）
- **Sprint 3**: セクション 11–13（PCA/合成・クリーニング・スケーリング）
- **Sprint 4**: セクション 14–15（統合 A/B・昇格）

各ステップ完了後は MSR/Sharpe 指標と Kaggle LB を両面確認し、効果が出ない場合は即座にロールバックする。
