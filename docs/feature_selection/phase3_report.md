# Phase 3 実行レポート: 相関クラスタリングと最終特徴セット確定

## 実行日時

- 開始: 2025-12-11
- LB検証完了: 2025-12-12
- ステータス: **完了**

---

## サマリー

| 項目 | 値 |
|------|-----|
| **最終採用Feature Set** | FS_compact (Tier3) |
| 入力特徴量数 | 120列（Tier2） |
| 出力特徴量数 | 116列（Tier3） |
| 削減数 | 4列（-3.3%） |
| OOF RMSE | 0.012164（-0.000008改善） |
| **LB Score** | **0.681**（維持） |

---

## Phase 3-1: 相関クラスタリング

### 設定

- **閾値**: |ρ| > 0.95
- **手法**: 階層クラスタリング（Ward法）
- **対象**: Tier2の120列

### 結果

| 指標 | 値 |
|------|-----|
| 検出クラスタ数 | 4 |
| シングルトン特徴量 | 116 |
| 最大相関係数 | 0.9711（E11-E12） |

### クラスタ詳細

| Cluster | 特徴量 | 代表 | 最大相関 | 削除対象 |
|---------|--------|------|----------|----------|
| 1 | E3, E4 | E4 | 0.9542 | E3 |
| 2 | E11, E12 | E12 | 0.9711 | E11 |
| 3 | V4, V5 | V5 | 0.9652 | V4 |
| 4 | V9, V10 | V9 | 0.9614 | V10 |

---

## Phase 3-2: クラスタ代表選出

### 選出基準

1. **Importance最大**: `mean_gain`が最大の列を代表とする
2. **生特徴優先**: 同等のimportanceなら生特徴（D, E, I, M, P, S, V）を優先
3. **1クラスタ1代表**: 各クラスタから1列のみ残す

### 代表選出結果

| Cluster | 代表 | mean_gain | 削除 | mean_gain |
|---------|------|-----------|------|-----------|
| 1 | E4 | 95.2 | E3 | 51.0 |
| 2 | E12 | 103.8 | E11 | 28.0 |
| 3 | V5 | 110.6 | V4 | 93.6 |
| 4 | V9 | 78.6 | V10 | 45.0 |

**削除対象**: E3, E11, V4, V10（計4列）

---

## Phase 3-3: Tier3評価

### OOF評価結果

| 指標 | Tier2 | Tier3 | 差分 | 判定 |
|------|-------|-------|------|------|
| OOF RMSE | 0.012172 | 0.012164 | -0.000008 | ✅ 改善 |
| OOF MSR | 0.020386 | 0.019361 | -0.001025 | ✅ 改善 |
| 特徴量数 | 120 | 116 | -4 | ✅ 削減 |

### 判定

- **RMSE悪化 ≤ +0.0001**: ✅ 満たす（むしろ-0.000008改善）
- **列数減**: ✅ 120→116列（-4列）
- **結論**: **Tier3採用**

---

## Phase 3-4: Feature Set定義

### 定義したFeature Set

| セット名 | 説明 | 列数 | OOF RMSE | LB Score | ステータス |
|---------|------|------|----------|----------|------------|
| FS_full | Tier2そのまま | 120 | 0.012172 | 0.681 | baseline |
| **FS_compact** | Tier3（相関クラスタ後） | 116 | 0.012164 | **0.681** | **採用** |
| FS_topK | importance上位50列 | 50 | 0.012023 | 0.589 | 非採用 |

### 推奨: FS_compact

```json
{
  "recommended": "FS_compact",
  "lb_validation": {
    "validated_at": "2025-12-12",
    "conclusion": "FS_compact採用: LB維持(0.681)かつ特徴量4列削減(120→116)"
  }
}
```

---

## LB検証結果

### 検証日: 2025-12-12

| Feature Set | LB Score | OOF RMSE | OOF→LB Gap | 判定 |
|-------------|----------|----------|------------|------|
| FS_full | 0.681 | 0.012172 | - | baseline |
| FS_compact | 0.681 | 0.012164 | なし | ✅ 採用 |
| FS_topK | 0.589 | 0.012023 | **-13.5%** | ❌ 過学習 |

### FS_topK過学習分析

**問題**: OOF最良（0.012023）にもかかわらずLBで-13.5%大幅悪化

**原因**:

1. **SU1特徴量の欠落**
   - FS_topKではSU1生成列が全て除外
   - importance上位50列が全て生特徴量だったため
   - SU1特徴量（欠損構造情報）は汎化に寄与していた

2. **情報の過度な圧縮**
   - 50列では市場レジームの多様性が不足
   - 学習データの特定パターンに過適合

3. **Importanceの罠**
   - importance高 ≠ 未来データで有用

**教訓**:
- OOF改善だけを見て特徴量を大幅削減するのは危険
- 相関クラスタリングで冗長列を削除するのは安全
- LB検証は必須

---

## 生成物

### configs/

| ファイル | 説明 |
|----------|------|
| `feature_selection/tier3/excluded.json` | Tier3除外リスト（461列） |
| `feature_selection/tier_topK/excluded.json` | TopK除外リスト（527列） |
| `feature_selection/feature_sets.json` | Feature Set定義 |

### results/

| ファイル | 説明 |
|----------|------|
| `feature_selection/phase3/correlation_clusters.json` | 相関クラスタ結果 |
| `feature_selection/phase3/cluster_representatives.json` | 代表選出結果 |
| `feature_selection/tier3/tier1_evaluation.json` | Tier3評価結果 |

### artifacts/

| ディレクトリ | 説明 |
|--------------|------|
| `tier3/` | FS_compact用アーティファクト |
| `tier_topK/` | FS_topK用アーティファクト（参考保存） |

---

## 特徴量選定の全体推移

```
Phase 0: 577列（全特徴量）
    ↓ Phase 1: 低分散・定数列削除（-417列）
Phase 1: 160列（-72%）
    ↓ Phase 2: Zero/Low importance削除（-40列）
Phase 2: 120列（-25%）
    ↓ Phase 3: 相関クラスタリング（-4列）
Phase 3: 116列（-3%）← 最終
```

**累積削減率**: 577列 → 116列 = **-80%**

---

## 結論

1. **FS_compact（Tier3）を最終Feature Setとして採用**
   - LB 0.681を維持しながら4列削減
   - OOF RMSEも微改善

2. **FS_topKは過学習のため非採用**
   - OOF最良でもLBで-13.5%悪化
   - SU1特徴量の欠落が主因

3. **Phase 3完了**
   - 特徴量選定フェーズ終了
   - 次フェーズ（モデル選定・ハイパラ最適化）へ進む準備完了

---

## 次ステップ

1. **モデル選定**: LGBM以外のモデル（XGBoost, CatBoost, Ridge等）をFS_compactで評価
2. **ハイパラ最適化**: 確定した116列でハイパラチューニング
3. **アンサンブル**: 複数モデル・Feature Setの組み合わせ

---

## 参照

- [Phase 3仕様書](phase3_spec.md)
- [Phase 2レポート](phase2_report.md)
- [Phase 1レポート](phase1_report.md)
- [提出履歴](../submissions.md)
