su1:
  id_column: date_id
  exclude_columns:
    - forward_returns
    - risk_free_rate
    - market_forward_excess_returns
  groups:
    include: ["M", "E", "I", "P", "S", "V"]
    exclude: []
  gap_clip: 60
  run_clip: 60
  dtype:
    flag: uint8
    run: int16
  include_group_means:
    gap_ffill: true
    run_na: true
    exclude_all_nan: true
  data:
    raw_dir: data/raw
    train_filename: train.csv
    test_filename: test.csv
  metadata:
    artifacts_dir: artifacts/SU1
    kaggle_lb: 0.674
    numpy_version: 1.26.4
    updated_at: 2025-11-04
    notes: "Artifacts regenerated with uv under pinned numpy 1.26.4 to keep MT19937 compatibility."

su2:
  # ⚠️ SU2は非採用 (2025-11-21決定)
  # 理由: LB 0.597 (SU1の0.674から-0.077ポイント大幅悪化)
  # 原因: 935個の二次特徴量による過学習・汎化性能低下
  # 結論: SU1をベースラインとして継続採用
  enabled: false
  base_features: su1
  id_column: date_id
  # 最終確定: config_id=3 (2025-11-07)
  input_sources: [m, gap_ffill, run_na, run_obs]
  target_groups:
    include: ["D", "M", "E", "I", "P", "S", "V"]
    exclude: []
  # 固定パラメータ（スイープ停止）
  rolling_windows: [5]
  ewma_alpha: [0.1]
  recovery_clip: 60
  dtype:
    flag: uint8
    run: int16
    float: float32
  features:
    rolling:
      include_metrics: [mean, std]
      include_current: [false]
      fill_missing_with_zero: true
    ewma:
      signals: [m, gap_ffill]
      include_std: [true]
      reset_each_fold: [true]
    transitions:
      windows: [5, 10, 20, 60]
      flip_rate_windows: [5, 10, 20, 60]
      burst_score_windows: [5, 10, 20, 60]
      recovery_feature: true
    normalization:
      windows: [5, 10, 20, 60]
      minmax_windows: [5, 10, 20, 60]
      rank_windows: [5, 10, 20, 60]
      epsilon: 1.0e-6
  include_rolling: [true]
  include_ewma: [true]
  include_transitions: [true]
  include_normalization: [true]
  normalization_mode: [both]
  epsilon: [1.0e-6]
  output_prefix: su2
  clip_max: 30
  drop_constant_columns: [true]
  metadata:
    artifacts_dir: artifacts/SU2
    depends_on: SU1
    expected_usage: "Roll-based missingness regime detection over SU1 outputs"
    numpy_version: 1.26.4
    status: deprecated  # stable → deprecated
    kaggle_lb: 0.597  
    oof_rmse: 0.01223  
    decision: not_adopted  
    updated_at: 2025-11-21  
    notes: "⚠️ NON-ADOPTED: LB score 0.597 (vs SU1's 0.674). Overfitting due to 935 secondary features. Stage2 best config (id=3) parameters preserved for reference: windows=[5], alpha=0.1, transitions/normalization windows=[5,10,20,60], metrics=mean|std, signals=m|gap_ffill, recovery_clip=60, clip_max=30."

su3:
  # ✅ SU3 Stage 1 採用決定 (2025-11-22)
  # LB提出準備中 (目標: ≥0.672、SU1比で非劣化)
  # Stage 2（代入影響トレース）は提出後のLB結果で判断
  enabled: true  # ✅ 採用決定、訓練開始
  base_features: su1
  id_column: date_id
  output_prefix: su3
  
  # ========================================
  # Stage 1 採用構成（OOF Sweep ベスト）
  # ========================================
  # OOF性能:
  #   - RMSE: 0.011107
  #   - MSR: 0.005772 (Sharpe-like指標)
  #   - 特徴量数: 444列 (SU1: 368列 + SU3: 76列)
  #   - 実行時間: 12.0秒/構成
  # 
  # スイープ結果 (48構成):
  #   - MSR範囲: -0.009764 ～ 0.005772
  #   - reappear_top_k=20が最高MSR
  #   - temporal_top_k=10で安定、30で過学習傾向
  #   - holiday_top_k=10で十分
  # 
  # SU2の教訓を反映:
  #   ✅ 特徴量数444列（SU2: 1397列から68%削減）
  #   ✅ top-k選択で枝刈り（過学習回避）
  #   ✅ 群集約で次元削減（遷移フラグ: 188列→6列）
  #   ✅ Stage 1でミニマル実装（Stage 2は慎重判断）
  # ========================================
  
  # Stage 1: ミニマル実装（~76列追加）
  include_transitions: true
  transition_group_agg: true  # 群集約のみ（6列）
  
  include_reappearance: true
  reappear_clip: 60
  reappear_top_k: 20  # ✅ ベスト構成（スイープ結果）
  
  include_imputation_trace: false  # Stage 1ではオフ
  imp_delta_winsorize_p: 0.99
  imp_delta_top_k: 20
  imp_policy_group_level: true
  
  include_temporal_bias: true
  temporal_burn_in: 3
  temporal_top_k: 10  # ✅ ベスト構成（スイープ結果、20→10に変更）
  
  include_holiday_interaction: true
  holiday_top_k: 10  # ✅ ベスト構成（スイープ結果、20→10に変更）
  
  # データ型
  dtype:
    flag: uint8
    int: int16
    float: float32
  
  # fold境界リセット
  reset_each_fold: true
  
  # ========================================
  # Stage 2 構成（未実装、提出後検討）
  # ========================================
  # 追加内容:
  #   - imp_used/<col>: 代入実施フラグ (94列)
  #   - imp_delta/<col>: 補完値との差分 (94列)
  #   - imp_absdelta/<col>: 差分の絶対値 (94列)
  #   - imp_policy_<grp>/<policy>: 補完ポリシー (30-50列)
  #   - 合計: ~220-240列追加 → 総計660-684列
  # 
  # 実行条件（すべて満たす場合のみ）:
  #   1. Stage 1 LB ≥ 0.672 (SU1比で非劣化)
  #   2. Stage 1が安定稼働
  #   3. _generate_imputation_features()実装完了
  #   4. Stage 2スイープでMSR +0.001以上
  #   5. 特徴量数 < 700列
  # 
  # リスク:
  #   - 特徴量660列超→SU2の二の舞
  #   - 過学習の懸念（CV良好→LB劣化）
  # 
  # 判断: Stage 1のLB結果を見て決定
  # ========================================
  
  metadata:
    artifacts_dir: artifacts/SU3
    depends_on: SU1
    expected_usage: "Transition, reappearance, temporal bias features (Stage 1)"
    numpy_version: 1.26.4
    status: adoption_pending  # development → adoption_pending
    stage: 1  # Stage 1採用、Stage 2は保留
    kaggle_lb: null  # 提出後更新
    oof_rmse: 0.011107
    oof_msr: 0.005772
    feature_count: 444
    sweep_date: 2025-11-22
    sweep_configs: 48
    best_config:
      reappear_top_k: 20
      temporal_top_k: 10
      holiday_top_k: 10
      include_imputation_trace: false
    decision: stage1_adopted  # Stage 1採用決定
    troubleshooting:
      - issue: "MSR=0問題 (2025-11-22解決済み)"
        cause: "PostProcessParams(lo=1.0, hi=1.0)でシグナル定数化"
        fix: "lo=0.0, hi=2.0に変更"
        doc: "docs/feature_generation/troubleshooting/MSR_zero_issue.md"
    updated_at: 2025-11-22
    notes: "✅ Stage 1採用決定。特徴量444列（SU2比68%削減）、OOF MSR=0.005772。top-k選択と群集約でSU2の過学習を回避。Kaggle提出準備中（目標LB≥0.672）。Stage 2は提出後のLB結果で判断。"